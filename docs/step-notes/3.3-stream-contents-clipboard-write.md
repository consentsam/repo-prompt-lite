## Step 3.3 â€“ Stream contents & clipboard write

### What

- **Task**: Implement functionality to read selected files, construct a payload string with their contents, enforce a 2 million token limit, and write this payload to the system clipboard.
- **Implementation Details**:
    - **Main Process (`src/main/main.ts`)**:
        - Added a new IPC handler: `ipcMain.handle('generate-payload-and-copy', async (_, selectedFiles) => { ... })`.
        - This handler receives an array of selected file objects (containing `path`, `relativePath`, `tokenEstimate`, `isDirectory`, `isSkipped`).
        - It iterates through the files, skipping directories and already skipped files.
        - It maintains a running total of tokens (`currentTotalTokens`) using `file.tokenEstimate`.
        - **Token Cap Enforcement**: 
            - If adding a file would exceed `MAX_TOKENS` (2,000,000), that file and subsequent files are skipped. 
            - A warning is logged if `currentTotalTokens` exceeds `WARN_TOKENS_THRESHOLD` (1,800,000).
        - For each valid file within the token limit, its content is read using `fs.promises.readFile(file.path, 'utf-8')`.
        - The payload is constructed by appending strings in the format:
          ```
          <file_path>path/to/file.ext</file_path>
          <file_contents>
          ...content...
          </file_contents>
          
          ```
        - After processing all allowed files, `clipboard.writeText(payload.trim())` copies the result.
        - Returns an object `{ success: boolean; message: string; CANCELED_BECAUSE_TOO_LARGE_BOOLEAN?: boolean; tokens?: number }` to the renderer.
    - **Renderer Process (`src/renderer/App.tsx`)**:
        - Modified the `handleCopyToClipboard` async function.
        - It now calls `window.api.generatePayloadAndCopy(filesToCopy)` (where `filesToCopy` is derived from `processedSelection.files`).
        - The existing UI state logic (`isCopying`, `copyResult`) is used to provide feedback to the user based on the response from the main process.
    - **Preload Script (`src/preload/index.ts`)**:
        - Added `generatePayloadAndCopy` to the `contextBridge.exposeInMainWorld('api', { ... })` object, mapping it to `ipcRenderer.invoke('generate-payload-and-copy', selectedFiles)`.
    - **Type Definitions (`src/renderer/types/api.d.ts`)**:
        - Added `generatePayloadAndCopy` to the `API` interface to provide type safety for `window.api` calls in the renderer.
        - Defined a `CopyPayloadResponse` interface in `App.tsx` for the expected response structure (a shared type would be a future improvement).

### Testing

- **IPC Communication**:
    - Verified that `App.tsx` correctly calls the `generate-payload-and-copy` IPC channel with the selected files.
    - Verified that the main process handler receives the file list.
- **File Reading & Payload Construction**:
    - Tested with a small selection of text files; confirmed the payload is generated in the correct format and copied to the clipboard.
    - Verified that directories and files marked `isSkipped` are ignored.
- **Token Limit Enforcement**:
    - Tested with a selection of files that would exceed the 2M token limit. Confirmed that files are processed until the limit is neared/reached, and subsequent files are skipped.
    - Confirmed the `CANCELED_BECAUSE_TOO_LARGE_BOOLEAN` flag and appropriate message are returned to the renderer.
    - Monitored console logs in the main process for warnings when the 1.8M token threshold is crossed and when the 2M cap is hit.
- **Clipboard Functionality**:
    - Pasted the clipboard content after a successful copy operation to verify its integrity.
- **UI Feedback**:
    - Ensured "Copying..." state is shown during the operation.
    - Ensured success or failure messages (including token limit messages) are displayed to the user in `App.tsx` via the `copyResult` state.
- **Error Handling**:
    - Tested with non-existent file paths (if possible by manipulating the `selectedFiles` data before IPC call) or unreadable files to ensure graceful error handling in the main process (files are skipped, errors logged).
    - Verified that `App.tsx` handles errors from the IPC call.

### Follow-ups

- Consider adding a progress indicator for the copy operation, which would require the main process to send progress updates back to the renderer during file processing.
- Centralize shared type definitions (like `CopyPayloadResponse`) if they are used across main and renderer processes more extensively.
- Resolve any potential TypeScript language server caching issues that might prevent `api.d.ts` changes from being immediately recognized in the renderer. 